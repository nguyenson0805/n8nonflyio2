name: Fly Deploy
on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy to Fly
    runs-on: ubuntu-latest
    concurrency: deploy-group

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
        with:
          version: latest

      - name: Print flyctl version
        run: flyctl version

      - name: Authenticate to Fly (using token from GitHub Secrets)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "${FLY_API_TOKEN}" | flyctl auth login --access-token
          flyctl whoami || true

      - name: Deploy to Fly (remote-only)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
        run: |
          echo "${FLY_API_TOKEN}" | flyctl auth login --access-token
          # remote-only builds on Fly's builder, good for CI
          flyctl deploy --app "${FLY_APP_NAME}" --remote-only

      - name: Wait for release to become healthy (short check)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
        run: |
          echo "${FLY_API_TOKEN}" | flyctl auth login --access-token
          # show recent status and allocations
          flyctl status --app "${FLY_APP_NAME}"
          # show a few recent log lines to help verify startup (last 30s)
          echo "---- recent logs (30s) ----"
          flyctl logs --app "${FLY_APP_NAME}" --since 30s | sed -n '1,200p' || true

      - name: Final note
        run: |
          echo "Done. If you used Fly dashboard to add env secrets (N8N_BASIC_AUTH_*, DB_SQLITE_POOL_SIZE, N8N_RUNNERS_ENABLED, etc.),"
          echo "open https://${{ secrets.FLY_APP_NAME }}.fly.dev to verify Basic Auth prompt and n8n UI."
