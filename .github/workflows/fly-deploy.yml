name: Fly Deploy
on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy app to Fly
    runs-on: ubuntu-latest
    concurrency: deploy-group

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
        with:
          version: latest

      - name: flyctl version
        run: flyctl version

      - name: Authenticate to Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "${FLY_API_TOKEN}" | flyctl auth login --access-token

      - name: Set n8n secrets on Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
          N8N_BASIC_AUTH_USER: ${{ secrets.N8N_BASIC_AUTH_USER }}
          N8N_BASIC_AUTH_PASSWORD: ${{ secrets.N8N_BASIC_AUTH_PASSWORD }}
        run: |
          echo "${FLY_API_TOKEN}" | flyctl auth login --access-token

          # Required for production
          flyctl secrets set --app "${FLY_APP_NAME}" \
            N8N_BASIC_AUTH_ACTIVE=true \
            N8N_BASIC_AUTH_USER="${N8N_BASIC_AUTH_USER}" \
            N8N_BASIC_AUTH_PASSWORD="${N8N_BASIC_AUTH_PASSWORD}" \
            N8N_OWNER_SETUP_SKIP=true \
            N8N_CREATOR_ID=__system \
            DB_SQLITE_POOL_SIZE=3 \
            N8N_RUNNERS_ENABLED=true \
            N8N_PROTOCOL=https

      - name: Deploy to Fly (remote-only)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
        run: |
          echo "${FLY_API_TOKEN}" | flyctl auth login --access-token
          flyctl deploy --app "${FLY_APP_NAME}" --remote-only
